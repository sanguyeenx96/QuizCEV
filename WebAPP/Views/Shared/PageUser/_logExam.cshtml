@model ViewModels.ExamResult.Response.ExamResultVm
@{
    float totalScore = Model.Score;
    string danhgia = (totalScore >= 80) ? "điểm cao" : (totalScore >= 60) ? "điểm số trung bình" : "điểm thấp";
    int demtn = 0;
    int demtl = 0;
    float scoreTN = ViewBag.scoreTN;
    float totalScoreTN = ViewBag.totalScoreTN;
    float scoreTL = ViewBag.scoreTL;
    float totalScoreTL = ViewBag.totalScoreTL;
    int slDungTN = ViewBag.slDungTN;
    int slCauhoiTN = ViewBag.slCauhoiTN;
    int slDungTL = ViewBag.slDungTL;
    int slCauhoiTL = ViewBag.slCauhoiTL;

}

<div class="modal-content">
    <div class="modal-header">
        <h1 class="modal-title display-6  ">
            <i class="bi-chevron-down"></i>
            Kết quả bài thi @Model.CategoryName
        </h1>
    </div>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12">
                @{
                    var borderClass = danhgia switch
                    {
                        "điểm cao" => "border-top-success border-top-3 mb-3",
                        "điểm số trung bình" => "border-top-warning border-top-3 mb-3",
                        "điểm thấp" => "border-top-danger border-top-3 mb-3",
                        _ => ""
                    };

                    var textClass = danhgia switch
                    {
                        "điểm cao" => "text-success",
                        "điểm số trung bình" => "text-warning",
                        "điểm thấp" => "text-danger",
                        _ => ""
                    };

                    var iconClass = danhgia switch
                    {
                        "điểm cao" => "điểm cao",
                        "điểm số trung bình" => "trung bình",
                        "điểm thấp" => "điểm thấp",
                        _ => ""
                    };
                }

                <div class="card mb-3 @borderClass">
                    <div class="card-body">
                        <h5 class="card-title">Điểm số @totalScore/100 điểm</h5>
                        <p class="card-text">
                            <small>Đánh giá: <b class="@textClass">@danhgia</b></small>
                        </p>
                        <hr>
                        <div style="position: relative; text-align: center;">
                            @*<div style="width: 100%; position: absolute; top: 50%; left: 0; transform: translateY(-50%);z-index:99999">
                            <h1 class="display-6 text-@textClass animate__animated animate__rotateIn">@iconClass</h1>
                            </div>*@
                            <canvas id="myChart3"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-12">
                <div class="card ">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4">
                                <div class="border-start border-start-4 border-start-info px-3 mb-3">
                                    <small class="text-medium-emphasis">Thời gian làm bài thi</small>
                                    <div class="fs-7">@Model.ThoiGianLamBai/@Model.ThoiGianChoPhepLamBai phút</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-start border-start-4 border-start-info px-3 mb-3">
                                    <small class="text-medium-emphasis">Trắc nghiệm</small>
                                    <div class="fs-7">@scoreTN/@totalScoreTN điểm</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-start border-start-4 border-start-info px-3 mb-3">
                                    <small class="text-medium-emphasis">Tự luận</small>
                                    <div class="fs-7">@scoreTL/@totalScoreTL điểm</div>
                                </div>
                            </div>
                        </div>
                        <nav>
                            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                                <button class="nav-link active" id="nav-home-tab" data-coreui-toggle="tab" data-coreui-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">
                                    <i class="bi-dot"></i>
                                    Phần thi trắc nghiệm
                                </button>
                                <button class="nav-link" id="nav-profile-tab" data-coreui-toggle="tab" data-coreui-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">
                                    <i class="bi-dot"></i>
                                    Phần thi tự luận
                                </button>
                            </div>
                        </nav>
                        <div class="tab-content" id="nav-tabContent">
                            <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" tabindex="0">
                                <div class="accordion">
                                    @foreach (var item in Model.LogExams.Where(x => x.LoaiCauHoi == "TN"))
                                    {
                                        demtn++;
                                        string idThe = "tn" + item.Id.ToString();
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-coreui-toggle="collapse" data-coreui-target="#@idThe" aria-expanded="false" aria-controls="@idThe">
                                                    <span class="badge bg-dark me-2" style="min-width:100px">
                                                        @demtn -
                                                        <small>
                                                            @{
                                                                if (item.Cautraloi == item.Dapandung)
                                                                {
                                                                    <span class="badge text-white bg-success" style="vertical-align: text-top;">
                                                                        @item.Score/@item.Score điểm
                                                                    </span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge text-white bg-danger" style="vertical-align: text-top;">
                                                                        0/@item.Score điểm
                                                                    </span>
                                                                }
                                                            }
                                                        </small>
                                                    </span>
                                                    @item.Cauhoi
                                                </button>
                                            </h2>
                                            <div id="@idThe" class="accordion-collapse collapse" data-coreui-parent="#accordionExample">
                                                <div class="accordion-body">
                                                    <div class="row">
                                                    @{
                                                        if (!string.IsNullOrEmpty(item.QA))
                                                        {
                                                            if (item.Dapandung == "A")
                                                            {
                                                                <div class="col-12">
                                                                    <div class="btn-group mb-2 rounded-0 w-100">
                                                                        <button class="btn btn-success disabled" style="border-right:1px solid">A</button>
                                                                        <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QA</button>
                                                                    </div>
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                if (item.Cautraloi == "A")
                                                                {
                                                                    <div class="col-12">
                                                                        <div class="btn-group mb-2 rounded-0 w-100">
                                                                            <button class="btn btn-danger disabled" style="border-right:1px solid">A</button>
                                                                            <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QA</button>
                                                                        </div>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <div class="col-12">
                                                                        <div class="btn-group mb-2 rounded-0 w-100">
                                                                            <button class="btn btn-light disabled" style="border-right:1px solid">A</button>
                                                                            <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QA</button>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            }
                                                        }
                                                        if (!string.IsNullOrEmpty(item.QB))
                                                        {
                                                            if (item.Dapandung == "B")
                                                            {
                                                                <div class="col-12">
                                                                    <div class="btn-group mb-2 rounded-0 w-100">
                                                                        <button class="btn btn-success disabled" style="border-right:1px solid">B</button>
                                                                        <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QB</button>
                                                                    </div>
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                if (item.Cautraloi == "B")
                                                                {
                                                                    <div class="col-12">
                                                                        <div class="btn-group mb-2 rounded-0 w-100">
                                                                            <button class="btn btn-danger disabled" style="border-right:1px solid">B</button>
                                                                            <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QB</button>
                                                                        </div>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <div class="col-12">
                                                                        <div class="btn-group mb-2 rounded-0 w-100">
                                                                            <button class="btn btn-light disabled" style="border-right:1px solid">B</button>
                                                                            <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QB</button>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            }
                                                        }
                                                        if (!string.IsNullOrEmpty(item.QC))
                                                        {
                                                            if (item.Dapandung == "C")
                                                            {
                                                                <div class="col-12">
                                                                    <div class="btn-group mb-2 rounded-0 w-100">
                                                                        <button class="btn btn-success disabled" style="border-right:1px solid">C</button>
                                                                        <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QC</button>
                                                                    </div>
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                if (item.Cautraloi == "C")
                                                                {
                                                                    <div class="col-12">
                                                                        <div class="btn-group mb-2 rounded-0 w-100">
                                                                            <button class="btn btn-danger disabled" style="border-right:1px solid">C</button>
                                                                            <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QC</button>
                                                                        </div>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <div class="col-12">
                                                                        <div class="btn-group mb-2 rounded-0 w-100">
                                                                            <button class="btn btn-light disabled" style="border-right:1px solid">C</button>
                                                                            <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QC</button>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            }
                                                        }
                                                        if (!string.IsNullOrEmpty(item.QD))
                                                        {
                                                            if (item.Dapandung == "D")
                                                            {
                                                                <div class="col-12">
                                                                    <div class="btn-group mb-2 rounded-0 w-100">
                                                                        <button class="btn btn-success disabled" style="border-right:1px solid">D</button>
                                                                        <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QD</button>
                                                                    </div>
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                if (item.Cautraloi == "D")
                                                                {
                                                                    <div class="col-12">
                                                                        <div class="btn-group mb-2 rounded-0 w-100">
                                                                            <button class="btn btn-danger disabled" style="border-right:1px solid">C</button>
                                                                            <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QD</button>
                                                                        </div>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <div class="col-12">
                                                                        <div class="btn-group mb-2 rounded-0 w-100">
                                                                            <button class="btn btn-light disabled" style="border-right:1px solid">D</button>
                                                                            <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QD</button>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            }
                                                        }
                                                    }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                            <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab" tabindex="0">
                                <div class="accordion">
                                @{
                                    foreach (var item in Model.LogExams.Where(x => x.LoaiCauHoi == "TL"))
                                    {
                                        float gettedScore = item.LogExamTrinhtuthaotacs.Sum(x => x.FinalScore);
                                        demtl++;
                                        string idThe = "tl" + item.Id.ToString();
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-coreui-toggle="collapse" data-coreui-target="#@idThe" aria-expanded="false" aria-controls="@idThe">
                                                    <span class="badge bg-dark me-2" style="min-width:100px">
                                                        @demtl -
                                                        <small>
                                                            <span class="badge text-bg-warning" style="vertical-align: text-top;">

                                                                @gettedScore/@item.Score điểm
                                                            </span>
                                                        </small>
                                                    </span>
                                                    @item.Cauhoi
                                                </button>
                                            </h2>
                                            <div id="@idThe" class="accordion-collapse collapse" data-coreui-parent="#accordionExample">
                                                <div class="accordion-body">
                                                    <p class="mb-1" style="text-align:start;font-weight:500;"> I. Sắp xếp theo đúng trình tự WSD:</p>
                                                    <table class="table table-bordered table-hover table-reponsive" style="width:100%">
                                                        <thead style="vertical-align:middle;font-size:small">
                                                            <tr>
                                                                <th class="col-8" style="text-align:start;font-weight: 300">
                                                                    Nội dung thao tác
                                                                </th>
                                                                <th class="col-1" style="text-align:center;font-weight: 300">
                                                                    Trả lời
                                                                </th>
                                                                <th class="col-1" style="text-align:center;font-weight: 300">
                                                                    Đáp án đúng
                                                                </th>
                                                                <th class="col-1" style="text-align:center;font-weight: 300">
                                                                    Điểm số
                                                                </th>
                                                                <th class="col-1" style="text-align:center;font-weight: 300">
                                                                    Kết quả
                                                                </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                                @foreach (var itemNoiDung in item.LogExamTrinhtuthaotacs.OrderBy(x => x.ThuTu))
                                                                {
                                                                    if (itemNoiDung.FinalScore == itemNoiDung.Score)
                                                                    {
                                                                        <tr style="text-align:center;vertical-align:middle" class="bg-success p-2 text-dark bg-opacity-10">
                                                                            <td style="text-align:start">
                                                                                @itemNoiDung.Text
                                                                            </td>
                                                                            <td>
                                                                                <strong>
                                                                                    @itemNoiDung.ThuTu
                                                                                </strong>
                                                                            </td>
                                                                            <td>
                                                                                @itemNoiDung.Answer
                                                                            </td>

                                                                            <td>
                                                                                @itemNoiDung.Score
                                                                            </td>
                                                                            <td>
                                                                                <span class="badge bg-success">OK</span>
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                    else
                                                                    {
                                                                        <tr style="text-align:center;vertical-align:middle" class="bg-danger p-2 text-dark bg-opacity-10">
                                                                            <td style="text-align:start">
                                                                                @itemNoiDung.Text
                                                                            </td>
                                                                            <td>
                                                                                <strong>
                                                                                    @itemNoiDung.ThuTu
                                                                                </strong>
                                                                            </td>
                                                                            <td>
                                                                                @itemNoiDung.Answer
                                                                            </td>

                                                                            <td>
                                                                                @itemNoiDung.Score
                                                                            </td>
                                                                            <td>
                                                                                <span class="badge bg-danger">NG</span>
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                }
                                                            </tbody>
                                                        </table>

                                                        <p class="mb-1" style="text-align:start;font-weight:500;"> II. Điểm chú ý tại công đoạn / Spec tại công đoạn (Nếu có):</p>
                                                        <table class="table table-bordered table-hover " style="width:100%">
                                                            <thead style="vertical-align:middle;font-size:small">
                                                                <tr>
                                                                    <th class="col-9" style="font-weight: 300;text-align:start">
                                                                        Điểm chú ý
                                                                    </th>
                                                                    <th class="col-1" style="text-align:center;font-weight: 300">
                                                                        Đáp án đúng
                                                                    </th>
                                                                    <th class="col-1" style="text-align:center;font-weight: 300">
                                                                        Trả lời
                                                                    </th>
                                                                    <th class="col-1" style="text-align:center;font-weight: 300">
                                                                        Kết quả
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @{
                                                                    foreach (var i in item.logExamDiemChuYs.OrderBy(x => x.CorrectAnswer).ToList())
                                                                    {
                                                                        <tr style="text-align:center;vertical-align:middle" class=" p-2 text-dark bg-opacity-10">
                                                                            <td style="text-align:start">
                                                                                @i.Text
                                                                            </td>
                                                                            <td>
                                                                                <strong>
                                                                                    @i.CorrectAnswer
                                                                                </strong>
                                                                            </td>
                                                                            <td>
                                                                                @i.Answer
                                                                            </td>

                                                                            <td>
                                                                                @{
                                                                                    if (i.Answer == i.CorrectAnswer)
                                                                                    {
                                                                                        <i style="color:green" class="bi-check"></i>
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <i style="color:red" class="bi-x"></i>
                                                                                    }
                                                                                }
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                }
                                                            </tbody>
                                                        </table>


                                                        <p class="mb-1" style="text-align:start;font-weight:600;"> III. Lỗi tại công đoạn:</p>
                                                        <table class="table table-bordered table-hover " style="width:100%">
                                                            <thead style="vertical-align:middle;font-size:small">
                                                                <tr>
                                                                    <th class="col-9" style="font-weight: 300;text-align:start">
                                                                        Lỗi tại công đoạn
                                                                    </th>
                                                                    <th class="col-1" style="text-align:center;font-weight: 300">
                                                                        Đáp án đúng
                                                                    </th>
                                                                    <th class="col-1" style="text-align:center;font-weight: 300">
                                                                        Trả lời
                                                                    </th>
                                                                    <th class="col-1" style="text-align:center;font-weight: 300">
                                                                        Kết quả
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @{
                                                                    foreach (var i in item.logExamLoiTaiCongDoans.OrderBy(x => x.CorrectAnswer).ToList())
                                                                    {
                                                                        <tr style="text-align:center;vertical-align:middle" class=" p-2 text-dark bg-opacity-10">
                                                                            <td style="text-align:start">
                                                                                @i.Text
                                                                            </td>
                                                                            <td>
                                                                                <strong>
                                                                                    @i.CorrectAnswer
                                                                                </strong>
                                                                            </td>
                                                                            <td>
                                                                                @i.Answer
                                                                            </td>
                                                                            <td>
                                                                                @{
                                                                                    if (i.Answer == i.CorrectAnswer)
                                                                                    {
                                                                                        <i style="color:green" class="bi-check"></i>
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <i style="color:red" class="bi-x"></i>
                                                                                    }
                                                                                }
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                }
                                                            </tbody>
                                                        </table>

                                                        <p class="mb-1" style="text-align:start;font-weight:600;"> IV. Đối sách:</p>
                                                        <table class="table table-bordered table-hover " style="width:100%">
                                                            <thead style="vertical-align:middle;font-size:small">
                                                                <tr>
                                                                    <th class="col-5" style="font-weight: 300;text-align:start">
                                                                        Đối sách
                                                                    </th>
                                                                    <th class="col-3" style="text-align:center;font-weight: 300">
                                                                        Đáp án đúng
                                                                    </th>
                                                                    <th class="col-3" style="text-align:center;font-weight: 300">
                                                                        Trả lời
                                                                    </th>

                                                                    <th class="col-1" style="text-align:center;font-weight: 300">
                                                                        Kết quả
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @{
                                                                    foreach (var i in item.logExamDoiSaches.OrderBy(x => x.CorrectAnswer).ToList())
                                                                    {
                                                                        <tr style="text-align:center;vertical-align:middle" class="p-2 text-dark bg-opacity-10">
                                                                            <td style="text-align:start">
                                                                                @i.Text
                                                                            </td>
                                                                            <td>
                                                                                <strong>
                                                                                    @i.CorrectAnswer
                                                                                </strong>
                                                                            </td>
                                                                            <td>
                                                                                @i.Answer
                                                                            </td>

                                                                            <td>
                                                                                @{
                                                                                    if (i.Answer == i.CorrectAnswer)
                                                                                    {
                                                                                        <i style="color:green" class="bi-check"></i>
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <i style="color:red" class="bi-x"></i>
                                                                                    }
                                                                                }
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () {
        Chart.register(ChartDataLabels); // Enable plugin
        const ctx = document.getElementById('myChart3').getContext('2d');
        var tracnghiemScore = @scoreTN;
        var tuluanScore = @scoreTL;
        var totalScore = tracnghiemScore + tuluanScore;
        var errorScore = 100 - totalScore;
        // Create a pie chart
        var myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Trắc nghiệm', 'Tự luận', 'Sai'],
                datasets: [{
                    data: [tracnghiemScore, tuluanScore, errorScore],
                    backgroundColor: [
                        'rgba(46, 184, 92, 0.5)',
                        'rgba(46, 184, 92, 0.5)',
                        'rgba(229, 83, 83, 0.5)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false,
                        text: 'Biểu đồ kết quả điểm số bài thi'
                    },
                    datalabels: {
                        formatter: (value, ctx) => {
                            return ctx.chart.data.labels[ctx.dataIndex] + ': ' + value + ' điểm';
                        },
                        color: 'black',
                        backgroundColor: 'hsla(70 100% 50% / 0.7)',
                        font: {
                            size: 12,
                        },
                        display: true,
                    },
                },
                tooltips: {
                    enabled: true,
                },

            }
        });
    })

</script>
