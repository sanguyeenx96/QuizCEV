@using ViewModels.Question.Response
@{
    string tenPhongthi = ViewBag.tenPhongthi.ToString();
    string hoten = ViewBag.hoten.ToString();
    float totalScore = ViewBag.totalScore;
    string danhgia = (totalScore >= 80) ? "điểm cao" : (totalScore >= 60) ? "điểm số trung bình" : "điểm thấp";
    int demtn = 0;
    int demtl = 0;

    float scoreTracNghiem = ViewBag.tracnghiemScore;
    float totalScoreTracNghiem = ViewBag.totalTracNghiemScore;
    float scoreTuLuan = ViewBag.tuluanScore;
    float totalScoreTuLuan = ViewBag.totalTuLuanScore;

    int thoiGianLamBai = ViewBag.thoiGianLamBai;
    int thoiGianChoPhepLamBai = ViewBag.thoiGianChoPhepLamBai;

    var chTL = ViewBag.chTL as List<ViewModels.CauHoiTuLuan.Response.CauHoiTuLuanVm>;
    var dsTL = ViewBag.dsTL as List<ViewModels.CauHoiTrinhTuThaoTac.Response.QuestionAndAnswerTrinhTuThaoTacVm>;
    var dsDCY = ViewBag.dsDCY as List<ViewModels.CauHoiTrinhTuThaoTac.Response.QuestionAndAnswerDiemChuYVm>;
    var dsLTCD = ViewBag.dsLTCD as List<ViewModels.CauHoiTrinhTuThaoTac.Response.QuestionAndAnswerLoiTaiCongDoanVm>;
    var dsDS = ViewBag.dsDS as List<ViewModels.CauHoiTrinhTuThaoTac.Response.QuestionAndAnswerDoiSachVm>;
}
@section Header
    {
    <partial name="PageUser/_header" />
    }
    @section SideBar
    {
    <partial name="PageUser/_sideBar" />
    }

    <h1 class="display-6 mb-3 ">
        <i class="bi-chevron-down"></i>
        Kết quả bài thi @tenPhongthi
    </h1>
    <hr />
    <div class="row">
        <div class="col-md-12">
            @{
            var borderClass = danhgia switch
            {
                "điểm cao" => "border-top-success border-top-3 mb-3",
                "điểm số trung bình" => "border-top-warning border-top-3 mb-3",
                "điểm thấp" => "border-top-danger border-top-3 mb-3",
                _ => ""
            };

            var textClass = danhgia switch
            {
                "điểm cao" => "text-success",
                "điểm số trung bình" => "text-warning",
                "điểm thấp" => "text-danger",
                _ => ""
            };

            var iconClass = danhgia switch
            {
                "điểm cao" => "OK",
                "điểm số trung bình" => "OK",
                "điểm thấp" => "NG",
                _ => ""
            };
        }

        <div class="card mb-3 @borderClass">
            <div class="card-body">
                <h5 class="card-title">Điểm số @totalScore/100 điểm</h5>
                <p class="card-text">
                    <small>Đánh giá: <b class="@textClass">@danhgia</b></small>
                </p>
                <hr>
                <div style="position: relative; text-align: center;">
                    @* <div style="width: 100%; position: absolute; top: 50%; left: 0; transform: translateY(-50%); ">
                    <h1 class="display-6 text-@textClass animate__animated animate__rotateIn">@iconClass</h1>
                    </div>*@
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="col-md-12">
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-4">
                    <div class="border-start border-start-4 border-start-info px-3 mb-3">
                        <small class="text-medium-emphasis">Thời gian làm bài</small>
                        <div class="fs-7">@thoiGianLamBai phút</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="border-start border-start-4 border-start-info px-3 mb-3">
                        <small class="text-medium-emphasis">Trắc nghiệm</small>
                        <div class="fs-7">@scoreTracNghiem/@totalScoreTracNghiem điểm</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="border-start border-start-4 border-start-info px-3 mb-3">
                        <small class="text-medium-emphasis">Tự luận</small>
                        <div class="fs-7">@scoreTuLuan/@totalScoreTuLuan điểm</div>
                    </div>
                </div>
            </div>
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active" id="nav-home-tab" data-coreui-toggle="tab" data-coreui-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">
                        <i class="bi-dot"></i>
                        Phần thi trắc nghiệm
                    </button>
                    <button class="nav-link" id="nav-profile-tab" data-coreui-toggle="tab" data-coreui-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">
                        <i class="bi-dot"></i>
                        Phần thi tự luận
                    </button>
                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" tabindex="0">
                    <div class="accordion">
                        @foreach (var item in ViewBag.dsTN as List<QuestionAndAnswerVm>)
                        {
                            demtn++;
                            string idThe = "tn" + item.Id.ToString();
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-coreui-toggle="collapse" data-coreui-target="#@idThe" aria-expanded="false" aria-controls="@idThe">
                                        <span class="badge bg-dark me-2" style="min-width:100px">
                                            @demtn -
                                            <small>
                                                @{
                                                    if (item.Answer == item.QCorrectAns)
                                                    {
                                                        <span class="badge text-white bg-success" style="vertical-align: text-top;">
                                                            @item.Score/@item.Score điểm
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge text-white bg-danger" style="vertical-align: text-top;">
                                                            0/@item.Score điểm
                                                        </span>
                                                    }
                                                }
                                            </small>
                                        </span>
                                        @item.Text
                                    </button>
                                </h2>
                                <div id="@idThe" class="accordion-collapse collapse" data-coreui-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <div class="row">
                                            @{
                                                if (!string.IsNullOrEmpty(item.QA))
                                                {
                                                    if (item.QCorrectAns == "A")
                                                    {
                                                        <div class="col-12">
                                                            <div class="btn-group mb-2 rounded-0 w-100">
                                                                <button class="btn btn-success disabled" style="border-right:1px solid">A</button>
                                                                <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QA</button>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        if (item.Answer == "A")
                                                        {
                                                            <div class="col-12">
                                                                <div class="btn-group mb-2 rounded-0 w-100">
                                                                    <button class="btn btn-danger disabled" style="border-right:1px solid">A</button>
                                                                    <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QA</button>
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="col-12">
                                                                <div class="btn-group mb-2 rounded-0 w-100">
                                                                    <button class="btn btn-light disabled" style="border-right:1px solid">A</button>
                                                                    <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QA</button>
                                                                </div>
                                                            </div>
                                                        }

                                                    }

                                                }
                                                if (!string.IsNullOrEmpty(item.QB))
                                                {
                                                    if (item.QCorrectAns == "B")
                                                    {
                                                        <div class="col-12">
                                                            <div class="btn-group mb-2 rounded-0 w-100">
                                                                <button class="btn btn-success disabled" style="border-right:1px solid">B</button>
                                                                <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QB</button>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        if (item.Answer == "B")
                                                        {
                                                            <div class="col-12">
                                                                <div class="btn-group mb-2 rounded-0 w-100">
                                                                    <button class="btn btn-danger disabled" style="border-right:1px solid">B</button>
                                                                    <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QB</button>
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="col-12">
                                                                <div class="btn-group mb-2 rounded-0 w-100">
                                                                    <button class="btn btn-light disabled" style="border-right:1px solid">B</button>
                                                                    <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QB</button>
                                                                </div>
                                                            </div>
                                                        }
                                                    }
                                                }
                                                if (!string.IsNullOrEmpty(item.QC))
                                                {
                                                    if (item.QCorrectAns == "C")
                                                    {
                                                        <div class="col-12">
                                                            <div class="btn-group mb-2 rounded-0 w-100">
                                                                <button class="btn btn-success disabled" style="border-right:1px solid">C</button>
                                                                <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QC</button>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        if (item.Answer == "C")
                                                        {
                                                            <div class="col-12">
                                                                <div class="btn-group mb-2 rounded-0 w-100">
                                                                    <button class="btn btn-danger disabled" style="border-right:1px solid">C</button>
                                                                    <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QC</button>
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="col-12">
                                                                <div class="btn-group mb-2 rounded-0 w-100">
                                                                    <button class="btn btn-light disabled" style="border-right:1px solid">C</button>
                                                                    <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QC</button>
                                                                </div>
                                                            </div>
                                                        }
                                                    }
                                                }
                                                if (!string.IsNullOrEmpty(item.QD))
                                                {
                                                    if (item.QCorrectAns == "D")
                                                    {
                                                        <div class="col-12">
                                                            <div class="btn-group mb-2 rounded-0 w-100">
                                                                <button class="btn btn-success disabled" style="border-right:1px solid">D</button>
                                                                <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QD</button>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        if (item.Answer == "D")
                                                        {
                                                            <div class="col-12">
                                                                <div class="btn-group mb-2 rounded-0 w-100">
                                                                    <button class="btn btn-danger disabled" style="border-right:1px solid">C</button>
                                                                    <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QD</button>
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="col-12">
                                                                <div class="btn-group mb-2 rounded-0 w-100">
                                                                    <button class="btn btn-light disabled" style="border-right:1px solid">D</button>
                                                                    <button style="text-align:start" class="btn w-100 text-black btn-light" disabled>@item.QD</button>
                                                                </div>
                                                            </div>
                                                        }
                                                    }
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab" tabindex="0">
                    <div class="accordion">
                        @{
                            var groupdsTL = dsTL.GroupBy(x => x.CauHoiTuLuanId);
                            foreach (var group in groupdsTL) //Với mỗi group tương ứng với câu hỏi tự luận
                            {
                                demtl++;
                                string idThe = "tl" + group.FirstOrDefault().Id.ToString();
                                int cauhoituluanId = group.FirstOrDefault().CauHoiTuLuanId;
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-coreui-toggle="collapse" data-coreui-target="#@idThe" aria-expanded="false" aria-controls="@idThe">
                                            <span class="badge bg-secondary me-2 ">
                                                Câu @demtl
                                                <small>
                                                    <span class="badge text-bg-light" style="vertical-align: text-top;">
                                                        @chTL.FirstOrDefault(x => x.Id == group.FirstOrDefault().CauHoiTuLuanId)?.Score điểm
                                                    </span>
                                                </small>
                                            </span>
                                            @group.FirstOrDefault().CauHoiTuLuanText
                                        </button>
                                    </h2>
                                    <div id="@idThe" class="accordion-collapse collapse" data-coreui-parent="#accordionExample">
                                        <div class="accordion-body">
                                            <p class="mb-1" style="text-align:start;font-weight:500;"> I. Sắp xếp theo đúng trình tự WSD:</p>
                                            <table class="table table-bordered table-hover " style="width:100%">
                                                <thead style="vertical-align:middle;font-size:small">
                                                    <tr>
                                                        <th class="col-8" style="text-align:start;font-weight: 300">
                                                            Nội dung thao tác
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Đáp án đúng
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Trả lời
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Điểm số
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Kết quả
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in group.OrderBy(x => x.ThuTu)) //Với mỗi câu hỏi trình tự thao tác
                                                    {
                                                        var checkTTTT = (item.Answer == item.ThuTu) ? true : false;
                                                        var checklistDCY = dsDCY.Where(x => x.CauhoitrinhtuthaotacId == item.Id).ToList();
                                                        var checklistLTCD = dsLTCD.Where(x => x.CauhoitrinhtuthaotacId == item.Id).ToList();

                                                        var checkisDCYCorrect = checklistDCY != null ? checklistDCY.All(c => c.Answer == c.CorrectAnswer) : true;
                                                        var checkisLTCDCorrect = checklistLTCD != null ? checklistLTCD.All(c => c.Answer == c.CorrectAnswer) : true;

                                                        var checkisDSCorrect = checklistLTCD.All(itemLTCD =>
                                                        {
                                                            var listDS = dsDS.Where(x => x.LoiTaiCongDoanId == itemLTCD.Id).ToList();
                                                            if (listDS != null)
                                                            {
                                                                if (listDS.All(c => c.Answer == c.CorrectAnswer))
                                                                {
                                                                    return true;
                                                                }
                                                                else
                                                                {
                                                                    return false;
                                                                }
                                                            }
                                                            else
                                                            {
                                                                return true;
                                                            }
                                                        });
                                                        var result = checkTTTT && checkisDCYCorrect && checkisLTCDCorrect && checkisDSCorrect ? "OK" : "NG";
                                                        var bgColorClass = checkTTTT && checkisDCYCorrect && checkisLTCDCorrect && checkisDSCorrect ? "bg-success" : "bg-danger";

                                                        <tr style="text-align:center;vertical-align:middle" class="@($"{bgColorClass} p-2 text-dark bg-opacity-10")">
                                                            <td style="text-align:start">@item.Text</td>
                                                            <td>
                                                                <strong>
                                                                    @item.ThuTu
                                                                </strong>
                                                            </td>
                                                            <td>@item.Answer</td>
                                                            <td style="font-size:x-small">@item.Score điểm</td>
                                                            <td>
                                                                <span class="badge @bgColorClass">
                                                                    @result
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>

                                            <p class="mb-1" style="text-align:start;font-weight:500;"> II. Điểm chú ý tại công đoạn / Spec tại công đoạn (Nếu có):</p>
                                            <table class="table table-bordered table-hover " style="width:100%">
                                                <thead style="vertical-align:middle;font-size:small">
                                                    <tr>
                                                        <th class="col-9" style="font-weight: 300;text-align:start">
                                                            Điểm chú ý
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Đáp án đúng
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Trả lời
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Kết quả
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @{
                                                        var listDCYdl = dsDCY.Where(x => x.CauHoiTuLuanId == cauhoituluanId).ToList();
                                                        foreach (var i in listDCYdl.OrderBy(x => x.CorrectAnswer))
                                                        {
                                                            <tr style="text-align:center;vertical-align:middle" class=" p-2 text-dark bg-opacity-10">
                                                                <td style="text-align:start">
                                                                    @i.Text
                                                                </td>
                                                                <td>
                                                                    <strong>
                                                                        @i.CorrectAnswer
                                                                    </strong>
                                                                </td>
                                                                <td>
                                                                    @i.Answer
                                                                </td>

                                                                <td>
                                                                    @{
                                                                        if (i.Answer == i.CorrectAnswer)
                                                                        {
                                                                            <i style="color:green" class="bi-check"></i>
                                                                        }
                                                                        else
                                                                        {
                                                                            <i style="color:red" class="bi-x"></i>
                                                                        }
                                                                    }
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>

                                            <p class="mb-1" style="text-align:start;font-weight:500;"> III. Lỗi tại công đoạn:</p>
                                            <table class="table table-bordered table-hover " style="width:100%">
                                                <thead style="vertical-align:middle;font-size:small">
                                                    <tr>
                                                        <th class="col-9" style="font-weight: 300;text-align:start">
                                                            Lỗi tại công đoạn
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Đáp án đúng
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Trả lời
                                                        </th>
                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Kết quả
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @{
                                                        var listLTCDdl = dsLTCD.Where(x => x.CauHoiTuLuanId == cauhoituluanId).ToList();
                                                        foreach (var i in listLTCDdl)
                                                        {
                                                            <tr style="text-align:center;vertical-align:middle" class="p-2 text-dark bg-opacity-10">
                                                                <td style="text-align:start">
                                                                    @i.Text
                                                                </td>
                                                                <td>
                                                                    <strong>
                                                                        @i.CorrectAnswer
                                                                    </strong>
                                                                </td>
                                                                <td>
                                                                    @i.Answer
                                                                </td>

                                                                <td>
                                                                    @{
                                                                        if (i.Answer == i.CorrectAnswer)
                                                                        {
                                                                            <i style="color:green" class="bi-check"></i>
                                                                        }
                                                                        else
                                                                        {
                                                                            <i style="color:red" class="bi-x    "></i>
                                                                        }
                                                                    }
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>

                                            <p class="mb-1" style="text-align:start;font-weight:500;"> IV. Đối sách:</p>
                                            <table class="table table-bordered table-hover " style="width:100%">
                                                <thead style="vertical-align:middle;font-size:small">
                                                    <tr>
                                                        <th class="col-5" style="font-weight: 300;text-align:start">
                                                            Đối sách
                                                        </th>
                                                        <th class="col-3" style="text-align:center;font-weight: 300">
                                                            Đáp án đúng
                                                        </th>
                                                        <th class="col-3" style="text-align:center;font-weight: 300">
                                                            Trả lời
                                                        </th>

                                                        <th class="col-1" style="text-align:center;font-weight: 300">
                                                            Kết quả
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @{
                                                        var listDSdl = dsDS.Where(x => x.CauHoiTuLuanId == cauhoituluanId).ToList();
                                                        foreach (var i in listDSdl)
                                                        {
                                                            <tr style="text-align:center;vertical-align:middle" class="p-2 text-dark bg-opacity-10">
                                                                <td style="text-align:start">
                                                                    @i.Text
                                                                </td>
                                                                <td>
                                                                    <strong>
                                                                        @i.CorrectAnswer
                                                                    </strong>
                                                                </td>
                                                                <td>
                                                                    @i.Answer
                                                                </td>

                                                                <td>
                                                                    @{
                                                                        if (i.Answer == i.CorrectAnswer)
                                                                        {
                                                                            <i style="color:green" class="bi-check"></i>
                                                                        }
                                                                        else
                                                                        {
                                                                            <i style="color:red" class="bi-x    "></i>
                                                                        }
                                                                    }
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        Chart.register(ChartDataLabels); // Enable plugin
        const ctx = document.getElementById('myChart').getContext('2d');
        var tracnghiemScore = @scoreTracNghiem;
        var tuluanScore = @scoreTuLuan;
        var totalScore = tracnghiemScore + tuluanScore;
        var errorScore = 100 - totalScore;
        // Create a pie chart
        var myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Trắc nghiệm', 'Tự luận', 'Sai'],
                datasets: [{
                    data: [tracnghiemScore, tuluanScore, errorScore],
                    backgroundColor: [
                        'rgba(46, 184, 92, 0.5)',
                        'rgba(46, 184, 92, 0.5)',
                        'rgba(229, 83, 83, 0.5)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false,
                        text: 'Biểu đồ kết quả điểm số bài thi'
                    },
                    datalabels: {
                        formatter: (value, ctx) => {
                            return ctx.chart.data.labels[ctx.dataIndex] + ': ' + value + ' điểm';
                        },
                        color: 'black',
                        backgroundColor: 'hsla(70 100% 50% / 0.7)',
                        font: {
                            size: 12,
                        },
                        display: true,
                    },
                },
                tooltips: {
                    enabled: true,
                },

            }
        });
    })

</script>
